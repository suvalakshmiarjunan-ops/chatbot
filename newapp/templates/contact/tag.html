{% extends 'layouts/base.html' %}

{% block title %}Add Tag - Speedbots{% endblock %}
{% load static %}

{% block content %}
<div class="main" style="padding:24px 32px; max-width:900px;">
  <div style="display:flex; align-items:center; justify-content:space-between;">
    <h1 style="margin-bottom:0;">Add Tag</h1>
    <!-- Button to open modal -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTagModal">
      Add Tag
    </button>
  </div>
  <hr>
  <h2>Tags and Assigned Users</h2>
  <table class="table table-hover" style="background:#fff; margin:auto;">
    <thead>
      <tr>
        <th style="width:40px"></th>
        <th>Name</th>
        <th>Contacts</th>
        <th style="width:40px"></th>
      </tr>
    </thead>
    <tbody>
      {% for entry in tag_list %}
      <tr class="tag-row" tabindex="0" onclick="toggleTag('{{ entry.tag.id }}')" style="cursor:pointer;">
        <td><input type="checkbox" disabled></td>
        <td>{{ entry.tag.name }}</td>
        <td>{{ entry.users|length }}</td>
        <td><span id="arrow-{{ entry.tag.id }}" class="arrow">&#x25BC;</span></td>
      </tr>
      <tr id="users-{{ entry.tag.id }}" class="tag-users-row" style="display:none; background:#f9fafb;">
        <td></td>
        <td colspan="3" style="padding-left:40px;">
          {% if entry.users %}
            <ul style="margin-bottom:0;">
              {% for user in entry.users %}
                <li>{{ user.name }} ({{ user.phone_no }})</li>
              {% endfor %}
            </ul>
          {% else %}
            <em>No users assigned</em>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal fade" id="addTagModal" tabindex="-1" aria-labelledby="addTagModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addTagModalLabel">New Tag</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="id_tag_name" class="form-label" style="font-weight:600;">Tag Name</label>
            <div class="input-group input-group-lg">
              <span class="input-group-text" id="tagname-addon">üè∑Ô∏è</span>
              <input 
                type="text" 
                name="tag_name"
                id="id_tag_name"
                class="form-control"
                placeholder="Enter a tag name (e.g., Active Customers)"
                aria-describedby="tagname-addon"
                autocomplete="off"
                required
              >
            </div>
            {% if form.tag_name.errors %}
              <div class="text-danger">{{ form.tag_name.errors }}</div>
            {% endif %}
          </div>

          <hr>
          <label for="user-search">Search Users:</label>
          <input type="text" id="user-search" class="form-control mb-2" placeholder="Type to filter users..." onkeyup="filterUsers()">
          {{ form.users }}
          {% if form.users.errors %}
            <div class="text-danger">{{ form.users.errors }}</div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Tag</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function toggleTag(tagId) {
  var userRow = document.getElementById('users-' + tagId);
  var arrow = document.getElementById('arrow-' + tagId);
  if (userRow.style.display === 'none' || userRow.style.display === '') {
    userRow.style.display = 'table-row';
    arrow.innerHTML = '&#x25B2;';
  } else {
    userRow.style.display = 'none';
    arrow.innerHTML = '&#x25BC;';
  }
}

function filterUsers() {
  var input = document.getElementById('user-search');
  var filter = input.value.toLowerCase();
  var select = document.getElementById("id_users");
  for (var i = 0; i < select.options.length; i++) {
    var txtValue = select.options[i].text.toLowerCase();
    select.options[i].style.display = txtValue.includes(filter) ? "" : "none";
  }
}
</script>

<style>
.tag-row:focus { background: #e6f0fa; outline: none; }
.tag-row:hover { background: #f1f5f9; }
.tag-users-row td { border-top: none !important; }
#id_users { height: 200px; width: 100%; }
.input-group-text { font-size: 1.2rem; }
</style>
{% endblock %}
