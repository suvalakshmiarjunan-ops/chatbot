{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Add Tag - Speedbots{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
<div class="main" style="padding:24px 0 24px 0; max-width:1200px; margin-left:0;">

  <script>
    function toggleTag(tagId) {
      var userRow = document.getElementById('users-' + tagId);
      var arrow = document.getElementById('arrow-' + tagId);
      if (!userRow || !arrow) return;

      if (userRow.style.display === 'none' || userRow.style.display === '') {
        userRow.style.display = 'table-row';
        arrow.innerHTML = '&#x25B2;'; // Up arrow ‚ñ≤
      } else {
        userRow.style.display = 'none';
        arrow.innerHTML = '&#x25BC;'; // Down arrow ‚ñº
      }
    }
  </script>

  <div style="display:flex; align-items:center; justify-content:space-between;">
    <h1 style="margin-bottom:0; font-size:2rem;">Add/Edit Tag</h1>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTagModal">
      Add/Edit Tag
    </button>
  </div>
  <hr>
  <h2 style="font-size:1.3rem;">Tags and Assigned Users</h2>
  <table class="table table-hover" style="background:#FBF3D5; width:100%; max-width:1200px; margin-left:0;">
    <thead>
      <tr>
        <th style="width:40px;"></th>
        <th style="min-width:240px; padding-left:36px;">Name</th>
        <th style="min-width:120px; padding-left:36px;">Contacts</th>
        <th style="width:40px;"></th>
      </tr>
    </thead>
    <tbody>
      {% for entry in tag_list %}
      <tr class="tag-row" data-tag-id="{{ entry.tag.id }}" tabindex="0" style="cursor:pointer;" onclick="toggleTag('{{ entry.tag.id }}')">
        <td style="padding-left:8px;"><input type="checkbox" disabled></td>
        <td style="padding-left:36px;">{{ entry.tag.name }}</td>
        <td style="padding-left:36px;">{{ entry.users|length }}</td>
        <td>
          <span id="arrow-{{ entry.tag.id }}" class="arrow" style="cursor:pointer;">&#x25BC;</span>
          <form method="post" action="{% url 'delete_tag' entry.tag.id %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-sm" style="margin-left:8px;"
              onclick="return confirm('Are you sure you want to delete this tag?');">
              Delete
            </button>
          </form>
        </td>
        
      </tr>
      <tr id="users-{{ entry.tag.id }}" class="tag-users-row" style="display:none; background:#f9fafb;">
        <td></td>
        <td colspan="3" style="padding-left:40px;">
          {% if entry.users %}
            <ul style="margin-bottom:0;">
              {% for user in entry.users %}
                <li>{{ user.name }} ({{ user.phone_no }})</li>
              {% endfor %}
            </ul>
          {% else %}
            <em>No users assigned</em>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal fade" id="addTagModal" tabindex="-1" aria-labelledby="addTagModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addTagModalLabel">Add or Edit Tag</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <!-- Tag Name Input -->
          <div class="mb-3">
            <label for="id_tag_name" class="form-label" style="font-weight:600;">Tag Name</label>
            <div class="input-group input-group-lg">
              <span class="input-group-text" id="tagname-addon">üè∑Ô∏è</span>
              <input 
                type="text" 
                name="tag_name"
                id="id_tag_name"
                class="form-control"
                placeholder="Enter a tag name (e.g., Active Customers)"
                aria-describedby="tagname-addon"
                autocomplete="off"
                value="{{ form.tag_name.value|default_if_none:'' }}"
                required
              >
            </div>
            {% if form.tag_name.errors %}
              <div class="text-danger">{{ form.tag_name.errors }}</div>
            {% endif %}
          </div>

          <!-- Users Checkbox List -->
          <div class="mb-3" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem;">
            <label for="id_users" class="form-label" style="font-weight:600;">Select Users</label>
            {{ form.users }}
            {% if form.users.errors %}
              <div class="text-danger">{{ form.users.errors }}</div>
            {% endif %}
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Tag</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
  .main {
    max-width:1200px;
    margin-left:0 !important;
    padding:24px 0 24px 0 !important;
    
  }
  .tag-row:focus { background: #e6f0fa; outline: none; }
  .tag-row:hover { background: transparent !important; }
  .tag-users-row td { border-top: none !important; }
  .input-group-text { font-size: 1.2rem; }

  /* Style checkbox list */
  #id_users {
    display: block;
  }
  #id_users li {
    display: block;
    margin-bottom: 0.3rem;
  }
 

</style>
{% endblock %}
